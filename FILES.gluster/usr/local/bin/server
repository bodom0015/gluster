#!/bin/sh
#
# Usage: ./server <my-ip> <peer1 ip> <peer2 ip> ...
#

# Grab ips from args
PEERS=(${@/$1/ })
HOST=$1

VOLNAME=ndslabs
BRKPATH=/var/glfs/ndslabs/brick0

DEBUG="echo"

echo Starting GlusterFS server on $HOST
echo Connecting to peers: ${PEERS[@]}

# Start supervisord to keep glusterd running
$DEBUG /usr/bin/supervisord

# Probe any existing peers
for i in "${PEERS[@]}"; do
	$DEBUG gluster peer probe $i
done

# Create necessary volume if it doesn't exist
$DEBUG mkdir -p $BRKPATH
$DEBUG gluster volume create $VOLNAME transport tcp $HOST:$BRKPATH
$DEBUG gluster volume start $VOLNAME
